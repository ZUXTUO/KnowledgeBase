<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>ä¹å¢ƒç¾ AI èŠå¤©æµ‹è¯•ç«™</title>
  <!-- å¼•å…¥ highlight.js æ ·å¼ -->
  <link rel="stylesheet" href="default.min.css">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    /* èŠå¤©å®¹å™¨è‡ªåŠ¨é€‚é…æ•´ä¸ªæµè§ˆå™¨çª—å£é«˜åº¦ */
    #chat-container {
      width: 100%;
      max-width: 800px;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 10px;
    }
    h2 {
      text-align: center;
      background: #25d366;
      color: white;
      margin: 0;
      padding: 15px;
    }
    #status {
      text-align: center;
      font-size: 12px;
      color: #333;
      padding: 5px;
      background: rgba(0, 0, 0, 0.05);
    }
    /* é¡¶éƒ¨æ§åˆ¶åŒºåŸŸ */
    #top-controls {
      text-align: center;
      padding: 10px;
    }
    #messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    .message {
      margin: 10px 0;
      padding: 10px 15px;
      border-radius: 20px;
      max-width: 75%;
      word-wrap: break-word;
      display: inline-block;
      line-height: 1.5;
    }
    .user { background: #dcf8c6; align-self: flex-end; }
    .bot {
      background: #fff;
      align-self: flex-start;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }
    #input-container {
      display: flex;
      padding: 10px;
      border-top: 1px solid #ddd;
      background: #fff;
    }
    #user-input {
      flex: 1;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 20px;
      outline: none;
      font-size: 16px;
    }
    #send-btn, #clear-btn, #toggle-markdown-btn, #toggle-context-btn {
      margin-left: 10px;
      padding: 12px 20px;
      border: none;
      background: #25d366;
      color: white;
      border-radius: 20px;
      cursor: pointer;
      font-size: 16px;
    }
    #send-btn:hover, #clear-btn:hover, #toggle-markdown-btn:hover, #toggle-context-btn:hover {
      background: #1eb85d;
    }
    @media (max-width: 600px) {
      #chat-container { height: 100%; border-radius: 0; }
    }
    /* æ‚¬æµ®è°ƒè¯•é¢æ¿æ ·å¼ï¼ˆç±»ä¼¼å¾®ä¿¡é£æ ¼ï¼‰ */
    #debug-panel {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 320px;
      height: 240px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      font-size: 14px;
      padding: 10px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }
    /* è°ƒè¯•é¢æ¿å¤´éƒ¨ */
    #debug-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f0f0f0;
      padding: 5px 10px;
      border-bottom: 1px solid #ccc;
      border-radius: 6px 6px 0 0;
      font-weight: bold;
    }
    #debug-panel-close {
      background: transparent;
      border: none;
      font-size: 16px;
      cursor: pointer;
      color: #888;
    }
    #debug-panel p { margin: 5px 0; }
    /* æ–°å¢ï¼šç½‘å€å°å¡ç‰‡æ ·å¼ */
    .url-card {
        display: inline-flex;
        align-items: center;
        border: 1px solid #25d366;
        border-radius: 12px;
        padding: 8px 12px;
        margin: 5px 0;
        background: #fff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.2s;
    }
    .url-card:hover {
        transform: translateY(-2px);
    }
    .url-card a {
        color: #25d366;
        text-decoration: none;
        font-weight: 500;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
  </style>
  <!-- å¼•å…¥ highlight.js ä¸ marked.js -->
  <script src="highlight.min.js"></script>
  <script src="marked.min.js"></script>
  <script>
    // é…ç½® marked è‡ªåŠ¨è¯†åˆ«ä»£ç å—å¹¶ä½¿ç”¨ highlight.js æ¸²æŸ“
    marked.setOptions({
      highlight: function(code, lang) {
        if (lang && hljs.getLanguage(lang)) {
          return hljs.highlight(code, { language: lang }).value;
        } else {
          return hljs.highlightAuto(code).value;
        }
      }
    });
  </script>
</head>
<body>
  <div id="chat-container">
    <h2>å¥¥å¸†å¸† AI èŠå¤© v2 (3Bæµ‹è¯•ç‰ˆ)</h2>
    <div id="status">æµ‹è¯•çº¿ç¨‹: 15 | GPUå ç”¨: 75%</div>
    <!-- é¡¶éƒ¨æ§åˆ¶åŒºåŸŸ -->
    <div id="top-controls">
      <button id="toggle-markdown-btn">å¼€å¯ Markdown(å†™ä»£ç æ—¶ä½¿ç”¨)</button>
      <button id="toggle-context-btn">å…³é—­ä¸Šä¸‹æ–‡(AIè®°å¿†æ··ä¹±æ—¶å¯ç”¨)</button>
    </div>
    <div id="messages"></div>
    <div id="input-container">
      <input type="text" id="user-input" placeholder="è¾“å…¥æ¶ˆæ¯...">
      <button id="send-btn">å‘é€</button>
      <button id="clear-btn">æ¸…é™¤</button>
    </div>
  </div>
  <!-- æ‚¬æµ®è°ƒè¯•é¢æ¿ -->
  <div id="debug-panel">
    <div id="debug-panel-header">
      è°ƒè¯•æ—¥å¿—
      <button id="debug-panel-close">Ã—</button>
    </div>
    <div id="debug-content"></div>
  </div>

  <script>
    // å…¨å±€å˜é‡æ§åˆ¶ Markdown æ¸²æŸ“ï¼ŒåŠä¸Šä¸‹æ–‡è®°å¿†
    let enableMarkdown = false;
    let enableContextMemory = true;
    let contextHistory = "";
    // å­˜æ”¾ data.jsonl æ–‡ä»¶ä¸­çš„å‚è€ƒæ•°æ®
    let referenceData = [];
    // åˆ¤æ–­æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡å‘é€æ¶ˆæ¯
    let firstMessage = true;

    // è°ƒè¯•æ—¥å¿—å‡½æ•°ï¼Œå°†ä¿¡æ¯è¾“å‡ºåˆ°è°ƒè¯•é¢æ¿çš„å†…å®¹åŒºåŸŸ
    function logDebug(info) {
      const debugContent = document.getElementById("debug-content");
      const p = document.createElement("p");
      p.textContent = info;
      debugContent.appendChild(p);
      debugContent.scrollTop = debugContent.scrollHeight;
    }

    // æŒ‰ä¸‹ Alt é”®æ˜¾ç¤ºæ‚¬æµ®è°ƒè¯•é¢æ¿
    document.addEventListener("keydown", function(e) {
      if (e.altKey) {
        document.getElementById("debug-panel").style.display = "block";
      }
    });
    // è°ƒè¯•é¢æ¿å…³é—­æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    document.getElementById("debug-panel-close").addEventListener("click", function() {
      document.getElementById("debug-panel").style.display = "none";
    });

    // å¯åŠ¨æ—¶è¯»å–æœ¬åœ° data.jsonl æ–‡ä»¶
    fetch('data.jsonl')
      .then(response => response.text())
      .then(text => {
        const lines = text.trim().split("\n");
        lines.forEach(line => {
          try {
            const jsonObj = JSON.parse(line);
            const parts = jsonObj.text.split("\n\n");
            if (parts.length >= 2) {
              const userPart = parts[0].replace(/^User:\s*/i, "");
              const assistantPart = parts[1].replace(/^Assistant:\s*/i, "");
              referenceData.push({ user: userPart, assistant: assistantPart });
            }
          } catch (e) {
            console.error("è§£æ data.jsonl æ—¶å‡ºé”™:", e);
            logDebug("è§£æ data.jsonl æ—¶å‡ºé”™: " + e);
          }
        });
        logDebug("æˆåŠŸåŠ è½½ data.jsonl, å‚è€ƒæ•°æ®æ¡æ•°: " + referenceData.length);
      })
      .catch(error => {
        console.error("æ— æ³•è¯»å– data.jsonl æ–‡ä»¶:", error);
        logDebug("æ— æ³•è¯»å– data.jsonl æ–‡ä»¶: " + error);
      });

    // åˆ‡æ¢ Markdown æ¸²æŸ“çŠ¶æ€
    document.getElementById("toggle-markdown-btn").addEventListener("click", function() {
      enableMarkdown = !enableMarkdown;
      this.textContent = enableMarkdown ? "å…³é—­ Markdown" : "å¼€å¯ Markdown";
      logDebug("Markdown çŠ¶æ€: " + (enableMarkdown ? "å¯ç”¨" : "å…³é—­"));
    });

    // åˆ‡æ¢ä¸Šä¸‹æ–‡è®°å¿†åŠŸèƒ½
    document.getElementById("toggle-context-btn").addEventListener("click", function() {
      enableContextMemory = !enableContextMemory;
      this.textContent = enableContextMemory ? "å…³é—­ä¸Šä¸‹æ–‡" : "å¼€å¯ä¸Šä¸‹æ–‡";
      if (!enableContextMemory) {
        contextHistory = "";
      }
      logDebug("ä¸Šä¸‹æ–‡è®°å¿†çŠ¶æ€: " + (enableContextMemory ? "å¼€å¯" : "å…³é—­"));
    });

    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
    function updateStatus() {
      const userCount = Math.floor(Math.random() * 11) + 10;
      const gpuUsage = Math.floor(Math.random() * 35) + 65;
      document.getElementById("status").textContent = `çº¿ç¨‹å ç”¨: ${userCount} | GPUå ç”¨: ${gpuUsage}%`;
    }
    setInterval(updateStatus, 5000);

    // è®¡ç®— Levenshtein è·ç¦»
    function levenshtein(a, b) {
      const matrix = [];
      const aLen = a.length;
      const bLen = b.length;
      if (aLen === 0) return bLen;
      if (bLen === 0) return aLen;

      for (let i = 0; i <= aLen; i++) {
        matrix[i] = [i];
      }
      for (let j = 0; j <= bLen; j++) {
        matrix[0][j] = j;
      }
      for (let i = 1; i <= aLen; i++) {
        for (let j = 1; j <= bLen; j++) {
          if (a.charAt(i - 1) === b.charAt(j - 1)) {
            matrix[i][j] = matrix[i - 1][j - 1];
          } else {
            matrix[i][j] = Math.min(
              matrix[i - 1][j] + 1,
              matrix[i][j - 1] + 1,
              matrix[i - 1][j - 1] + 1
            );
          }
        }
      }
      return matrix[aLen][bLen];
    }

    // è®¡ç®—ç›¸ä¼¼åº¦æ¯”ä¾‹ï¼ˆ0åˆ°1ä¹‹é—´ï¼‰ï¼›
    // å»é™¤æ ‡ç‚¹ç¬¦å·åå†æ¯”è¾ƒ
    function similarity(a, b) {
      a = stripPunctuation(a.toLowerCase());
      b = stripPunctuation(b.toLowerCase());
      const distance = levenshtein(a, b);
      const maxLen = Math.max(a.length, b.length);
      if (maxLen === 0) return 1;
      return 1 - distance / maxLen;
    }

    function m_similarity(a, b) {
      a = a.toLowerCase();
      b = b.toLowerCase();
      const distance = levenshtein(a, b);
      const maxLen = Math.max(a.length, b.length);
      if (maxLen === 0) return 1;
      return 1 - distance / maxLen;
    }

    // å»é™¤æ ‡ç‚¹ç¬¦å·ï¼ˆæ”¯æŒä¸­è‹±æ–‡ï¼‰
    function stripPunctuation(str) {
      // ä½¿ç”¨ Unicode å±æ€§åŒ¹é…å»é™¤æ‰€æœ‰æ ‡ç‚¹ç¬¦å·
      return str.replace(/[\p{P}\p{S}]/gu, '');
    }

// æ”¹è¿›åçš„ç½‘å€æ£€æµ‹å‡½æ•°
function convertUrlsToCards(text) {
    // å¢å¼ºç‰ˆæ­£åˆ™è¡¨è¾¾å¼ï¼Œæ”¯æŒä¸­æ–‡å‚æ•°å’Œæ­£ç¡®è¾¹ç•Œåˆ¤æ–­
    const urlRegex = /https?:\/\/(?:www\.)?[\w-]+\.[a-z]{2,}(?:[/?#][^\s<>"'{}\|\\^`ã€‚ï¼ï¼Ÿï¼Œã€ï¼›ï¼šï¼ˆï¼‰ã€ã€‘ã€Œã€ã€Šã€‹â€œâ€â€˜â€™]*)?/gi;
    
    return text.replace(urlRegex, function(match) {
        // æ™ºèƒ½æˆªæ–­å°¾éƒ¨æ ‡ç‚¹ï¼ˆä¿ç•™å…è®¸å‡ºç°åœ¨URLä¸­çš„ç¬¦å·ï¼‰
        const cleanedUrl = match.replace(/[ã€‚ï¼ï¼Ÿï¼Œï¼›ï¼šâ€â€™ï¼‰ã€‘ã€‰ã€ã€‹]+$/, '');
        
        try {
            const urlObj = new URL(cleanedUrl);
            // å¯¹è§£ç åçš„æŸ¥è¯¢å‚æ•°è¿›è¡Œç¾åŒ–å¤„ç†
            const searchParams = new URLSearchParams(urlObj.search);
            const decodedQuery = Array.from(searchParams.entries())
                .map(([k, v]) => `${k}=${decodeURIComponent(v)}`)
                .join('&');
            
            // æ„é€ æ›´å‹å¥½çš„æ˜¾ç¤ºæ–‡æœ¬
            const displayText = decodedQuery 
                ? `${urlObj.hostname}?${decodedQuery}`
                : urlObj.hostname;

            return `
                <div class="url-card" title="${cleanedUrl}">
                    <span style="margin-right:8px">ğŸŒ</span>
                    <a href="${cleanedUrl}" target="_blank">${displayText}</a>
                </div>
            `;
        } catch (e) {
            console.warn('æ— æ•ˆçš„URL:', cleanedUrl);
            return match; // è¿”å›åŸå§‹æ–‡æœ¬
        }
    });
}

    // æ—¶é—´ç›¸å…³çš„é—®é¢˜å‚è€ƒè¯­å¥ï¼ˆå¯æ‰©å±•ï¼‰
    const timeQuestions = [
        "ç°åœ¨æ˜¯å‡ ç‚¹",
        "ç°åœ¨æ˜¯ä»€ä¹ˆæ—¶é—´",
        "å½“å‰æ—¶é—´",
        "ç°åœ¨æ—¶é—´",
        "ç°åœ¨å‡ ç‚¹äº†",
        "å‡ ç‚¹é’Ÿäº†",
        "å‡ ç‚¹äº†",
        "ç°åœ¨æ˜¯æ—©ä¸Šå—",
        "ç°åœ¨æ˜¯æ—©æ™¨å—",
        "ç°åœ¨æ˜¯ä¸­åˆå—",
        "ç°åœ¨æ˜¯æ™šä¸Šå—",
        "ç°åœ¨æ˜¯å¤œæ™šå—",
        "ç°åœ¨æ˜¯ä¸‹åˆå—",
    ];

    // ä¿®æ”¹åçš„æ—¶é—´æ£€æµ‹é€»è¾‘
    function checkTimeQuestion(input) {
        // ç»Ÿä¸€å»é™¤æ ‡ç‚¹åæ¯”è¾ƒ
        const cleanInput = stripPunctuation(input);
        for (let question of timeQuestions) {
            if (similarity(cleanInput, question) >= 0.5) {
                return true;
            }
        }
        return false;
    }

    // å‘é€æ¶ˆæ¯ï¼ˆä¿®æ”¹ä¸º async ä»¥ä¾¿ç­‰å¾… person.txt çš„è·å–ï¼‰
    async function sendMessage() {
      let userMessage = document.getElementById("user-input").value.trim();
      if (userMessage === "") return;

      const messagesDiv = document.getElementById("messages");

      // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
      const userDiv = document.createElement("div");
      userDiv.className = "message user";
      userDiv.textContent = userMessage;
      messagesDiv.appendChild(userDiv);
      document.getElementById("user-input").value = "";

      // åˆ›å»ºæ˜¾ç¤ºæœºå™¨äººçš„æ¶ˆæ¯å®¹å™¨ï¼Œå¹¶æ˜¾ç¤ºâ€œæ­£åœ¨æ€è€ƒä¸­...â€æç¤º
      const botDiv = document.createElement("div");
      botDiv.className = "message bot";
      botDiv.textContent = "å¥¥å¸†å¸†æ­£åœ¨æ€è€ƒä¸­...";
      messagesDiv.appendChild(botDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;

      // ç”¨äºç´¯ç§¯æœºå™¨äººçš„å›å¤å†…å®¹
      let botMessage = "";
      let hasReceivedData = false;
      let timedOut = false;

      // è¶…æ—¶å®šæ—¶å™¨ï¼š10ç§’å†…æœªæ”¶åˆ°æ•°æ®åˆ™æ˜¾ç¤ºâ€œå“åº”è¶…æ—¶â€
      const timeoutTimer = setTimeout(() => {
        if (!hasReceivedData) {
          timedOut = true;
          botDiv.textContent = "å“åº”è¶…æ—¶";
          logDebug("å“åº”è¶…æ—¶");
        }
      }, 10000);

      // æ„é€ å‘é€ç»™ AI çš„æ¶ˆæ¯ï¼Œåˆå§‹ä¸ºç”¨æˆ·è¾“å…¥
      let messageToSend = userMessage;

      // å¦‚æœå¼€å¯ä¸Šä¸‹æ–‡è®°å¿†ï¼Œåˆ™åŠ å…¥ä¹‹å‰å¯¹è¯å†…å®¹
      if (enableContextMemory) {
        messageToSend = (contextHistory ? contextHistory + "\n" : "") + "User: " + userMessage;
      }

      // å¦‚æœç”¨æˆ·æé—®ä¸­åŒ…å«â€œæ—¶é—´â€ï¼Œé™„åŠ ç³»ç»Ÿæ—¶é—´
      if (checkTimeQuestion(userMessage)) {
        const nowStr = new Date().toLocaleString();
        messageToSend += "\nç³»ç»Ÿæ—¶é—´ï¼š" + nowStr;
        logDebug("é™„åŠ ç³»ç»Ÿæ—¶é—´ï¼š" + nowStr);
    }

      // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡å‘é€æ¶ˆæ¯ï¼Œåˆ™é™„åŠ  person.txt çš„å†…å®¹ï¼ˆä¸å‚ä¸ jsonl åŒ¹é…ï¼‰
      if (firstMessage) {
        try {
          const res = await fetch("person.txt");
          const personText = await res.text();
          messageToSend = "Person Info: " + personText + "\n" + messageToSend;
          logDebug("é™„åŠ  person.txt å†…å®¹");
        } catch (err) {
          logDebug("è¯»å– person.txt å¤±è´¥: " + err);
        }
        firstMessage = false;
      }

// åŒç­–ç•¥ç›¸ä¼¼åº¦è®¡ç®—ä¸æ‹©ä¼˜é€»è¾‘â€Œ:ml-citation{ref="1,2" data="citationList"}
let bestMatch = null;
let bestSim = 0;
for (let ref of referenceData) {
  // å¹¶è¡Œè®¡ç®—ä¸¤ç§ç›¸ä¼¼åº¦â€Œ:ml-citation{ref="2,8" data="citationList"}
  const sim1 = similarity(userMessage, ref.user);    // å»é™¤æ ‡ç‚¹ç­–ç•¥
  const sim2 = m_similarity(userMessage, ref.user);  // ä¿ç•™æ ‡ç‚¹ç­–ç•¥
  const currentSim = Math.max(sim1, sim2);           // æ‹©ä¼˜å–æœ€é«˜å€¼â€Œ:ml-citation{ref="1,8" data="citationList"}
  
  if (currentSim > bestSim) {
    bestSim = currentSim;
    bestMatch = ref;
    // è®°å½•ä¼˜é€‰ç­–ç•¥ç±»å‹â€Œ:ml-citation{ref="8" data="citationList"}
    bestMatch.simType = (sim1 > sim2) ? "å»æ ‡ç‚¹ç­–ç•¥" : "ç•™æ ‡ç‚¹ç­–ç•¥";
  }
}

if (bestSim >= 0.8 && bestMatch) {
  messageToSend += "\nã€‚åŸºäºä¸Šé¢è¿™ä¸ªé—®é¢˜ï¼Œå¿…é¡»å‚è€ƒä¸‹é¢çš„ç­”æ¡ˆé‡å¤ç»™æˆ‘ï¼š" + bestMatch.assistant;
  // æ—¥å¿—æ˜¾ç¤ºåŒç­–ç•¥ç»“æœâ€Œ:ml-citation{ref="8" data="citationList"}
  logDebug(`åŒ¹é…åˆ°å‚è€ƒç­”æ¡ˆï¼ŒåŒ¹é…æ–‡æœ¬ï¼š${bestMatch.user} (ç›¸ä¼¼åº¦: ${bestSim.toFixed(2)}, ç­–ç•¥: ${bestMatch.simType})`);
} else {
  logDebug("æ— åŒ¹é…å‚è€ƒç­”æ¡ˆ");
}


      // æ–°å¢å¯¼èˆªæ£€æµ‹é€»è¾‘
      const navigationRegex = /(å¸¦æˆ‘å»|å¯¼èˆªåˆ°)([^\sï¼Œã€‚ï¼ï¼Ÿ]+)/;
      const navMatch = userMessage.match(navigationRegex);
      if (navMatch && navMatch[2]) {
          const location = navMatch[2].replace(/[ã€‚ï¼ï¼Ÿ]$/, '');  // å»é™¤ç»“å°¾æ ‡ç‚¹
          const encodedLocation = encodeURIComponent(location);
          messageToSend += `\nï¼ˆã€‚åœ¨è¿™ä¸ªç½‘å€çš„åé¢åŠ ä¸Šæˆ‘æƒ³å»çš„åœ°æ–¹ï¼Œæˆ‘è¦æ±‚ä½ ç›´æ¥ç”Ÿæˆç½‘å€ï¼Œä¸è¦é—®æˆ‘å»å“ªé‡Œï¼Œåªå‘Šè¯‰æˆ‘ç½‘å€å°±å¯ä»¥äº†ï¼šhttps://www.amap.com/search?query=ï¼‰`;
      }

      logDebug("å‘é€ç»™AIçš„æ–‡æœ¬: " + messageToSend);

      // å‘é€è¯·æ±‚åˆ°åç«¯
      fetch("chat.php", {
        method: "POST",
        body: new URLSearchParams({ message: messageToSend })
      }).then(response => {
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = "";

        function processStream() {
          reader.read().then(({ done, value }) => {
            if (done || timedOut) return;
            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split("\n");
            buffer = lines.pop();

            for (let line of lines) {
              if (line.startsWith("data: ")) {
                let jsonStr = line.substring(6).trim();
                if (jsonStr === "[DONE]") {
                  if (enableContextMemory) {
                    contextHistory = (contextHistory ? contextHistory + "\n" : "") + "User: " + userMessage + "\nBot: " + botMessage;
                  }
                  logDebug("AI å›å¤å®Œæˆ: " + botMessage);
                  return;
                }
                try {
                  const dataObj = JSON.parse(jsonStr);
                  if (!hasReceivedData && dataObj.choices && dataObj.choices[0].delta.content) {
                    hasReceivedData = true;
                    clearTimeout(timeoutTimer);
                  }
                  if (dataObj.choices && dataObj.choices[0].delta.content) {
                    botMessage += dataObj.choices[0].delta.content;
                    // å…ˆè¿›è¡Œ URL è½¬æ¢ï¼Œå†æ ¹æ® Markdown è®¾ç½®æ˜¾ç¤º
                    const processedMsg = convertUrlsToCards(botMessage);
                    if (enableMarkdown) {
                      botDiv.innerHTML = marked.parse(processedMsg);
                    } else {
                      botDiv.innerHTML = processedMsg;
                    }
                  }
                } catch (e) {
                  console.error("JSONè§£æå¤±è´¥:", e);
                  logDebug("JSONè§£æå¤±è´¥: " + e);
                }
              }
            }
            processStream();
          });
        }
        processStream();
      }).catch(err => {
        clearTimeout(timeoutTimer);
        botDiv.textContent = "[é”™è¯¯] " + err;
        logDebug("è¯·æ±‚é”™è¯¯: " + err);
      });
    }

    document.getElementById("send-btn").addEventListener("click", sendMessage);
    document.getElementById("clear-btn").addEventListener("click", () => {
      document.getElementById("messages").innerHTML = "";
      // æ¸…ç©ºè°ƒè¯•é¢æ¿å†…å®¹
      document.getElementById("debug-content").innerHTML = "";
      location.reload(); 
    });
    document.getElementById("user-input").addEventListener("keypress", function(event) {
      if (event.key === "Enter") {
        event.preventDefault();
        sendMessage();
      }
    });
  </script>
</body>
</html>
